import { Effect } from "./base";
import {
  BuffTypes,
  triggerClauseType,
  SkillClassType,
} from "../../enums";
import { Character } from "../character";
import { Skill } from "../skill";
import { log } from "../../../logger";

export class Invulnerability extends Effect {
  private invulToSkillClass: SkillClassType;
  private invulToSpecifSkill: number;
  private invulToHarmful: boolean;
  private invulToFriendly: boolean;
  private skillName: string;

  constructor(data: any, caster: number) {
    super(data, caster);
    this.invulToFriendly = data.invulToFriendly || null;
    this.invulToHarmful = data.invulToHarmful || null;
    this.invulToSpecifSkill = data.invulToSpecifSkill || null;
    this.invulToSkillClass = data.invulToSkillClass || null;
  }

  public functionality(char: Character, origin: Skill) {
    const invul = char.getBuffs().invulnerability;
    const blockedInvul = char.getDebuffs().ignoreInvulnerability;
    const blockedBenefitial = char.getDebuffs().ignoreBenefitialEffects;

    if (blockedInvul || blockedBenefitial) {
      if (this.invulToSpecifSkill) {
        const skillName = this.arenaReference
          .findCharacterById(this.caster)
          .char.findSkillById(this.invulToSpecifSkill).name;
        invul.toSpecificSkill[this.invulToSpecifSkill] = true;
        this.skillName = skillName;
      }
      return;
    }

    if (this.invulToFriendly) invul.toFriendly = true;
    else if (this.invulToHarmful) invul.toHarmful = true;
    else if (this.invulToSkillClass)
      invul.toSkillClass[this.invulToSkillClass] = true;
    else if (this.invulToSpecifSkill) {
      const skillName = this.arenaReference
        .findCharacterById(this.caster)
        .char.findSkillById(this.invulToSpecifSkill).name;
      invul.toSpecificSkill[this.invulToSpecifSkill] = true;
      this.skillName = skillName;
    }
  }

  public generateToolTip() {
    if (this.invulToSpecifSkill) {
      this.message = `'${this.skillName}' can't be used on this character`;
    } else if (this.invulToSkillClass) {
      this.message = `This character is invulnerable to ${
        SkillClassType[this.invulToSkillClass]
      } skills`;
    } else if (this.invulToHarmful) {
      this.message = `This character is invulnerable`;
    } else if (this.invulToFriendly) {
      this.message = `This character is invulnerable to friendly skills`;
    }
  }
}

export class IgnoreInvulnerability extends Effect {
  constructor(data: any, caster: number) {
    super(data, caster);
  }

  functionality(char: Character, origin: Skill) {
    //log.info(`[ANTI-INVULNERABILITY]: activated on ${char.name}`);
    char.getDebuffs().ignoreInvulnerability = true;
  }

  generateToolTip() {
    this.message = "This character cannot become invulnerable";
  }
}
